<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestione Incassi Giornalieri</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
      rel="stylesheet" />
    <link
      rel="icon"
      type="image/png"
      sizes="100x100"
      href="https://img.icons8.com/office/100/money-bag-euro.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <style>
      .alert {
        animation: fade-out 3s forwards;
      }

      @keyframes fade-out {
        0% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      #user-info {
        font-size: 1rem;
        margin-right: 1rem;
      }

      #user-name {
        color: #555; /* Colore per una visibilità chiara */
      }

      .edit {
        display: none;
      }

      .view {
        display: table-cell; /* Le celle in modalità view sono visibili di default */
      }

      .input-group-sm .input-group-prepend,
      .input-group-sm .input-group-text {
        border-radius: 0;
        border-top-left-radius: 0.25rem; /* Arrotonda l'angolo in alto a sinistra */
        border-bottom-left-radius: 0.25rem; /* Arrotonda l'angolo in basso a sinistra */
      }

      .form-control-sm,
      .input-group-sm .form-control-sm,
      .input-group-sm .input-group-text {
        height: 31px; /* Uniforma l'altezza */
        line-height: normal; /* Assicura che il testo sia centrato verticalmente */
      }
    </style>
  </head>
  <body>
    <div class="bg-light py-2 px-3 border-bottom">
      <div class="d-flex align-items-center justify-content-between">
        <!-- Titolo a sinistra -->
        <div class="me-auto">
          <h1 class="mb-0">Gestione Incassi Giornalieri</h1>
        </div>

        <!-- Calendario al centro -->
        <div class="mx-auto">
          <input
            type="text"
            id="calendar"
            class="form-control text-center"
            placeholder="Seleziona una data" />
        </div>

        <!-- Utente a destra -->
        <div class="ms-auto">
          <div id="user-info" class="text-end">
            <span id="user-name" class="text-muted fw-bold"
              >Utente non registrato</span
            >
          </div>
        </div>
      </div>
    </div>

    <div class="container mt-5">
      <div class="d-flex justify-content-between align-items-center mt-3">
        <h2><span id="current-date"></span></h2>
        <h2>
          Totale Cassa: €<span id="totale-cassa" class="text-primary"
            >0.00</span
          >
        </h2>
      </div>

      <div class="d-flex justify-content-between mt-3">
        <h4>Totale Contanti: €<span id="totale-contanti">0.00</span></h4>
        <h4>Totale POS: €<span id="totale-pos">0.00</span></h4>
      </div>

      <form id="incasso-form" class="row g-3 needs-validation mt-2" novalidate>
        <div class="col-md-4">
          <label for="importo" class="form-label">Importo (€)</label>
          <input
            type="text"
            class="form-control"
            id="importo"
            placeholder="Inserisci importo"
            required
            oninput="validateImporto(this)" />
          <div id="importo-error" class="invalid-feedback">
            Inserisci un importo valido e positivo.
          </div>
        </div>

        <div class="col-md-1"></div>

        <!-- Radio Button-->
        <div class="col-md-2">
          <label class="form-label">Tipo Incasso</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="tipo-incasso"
              id="radio-entrate"
              value="entrate"
              required />
            <label class="form-check-label" for="radio-entrate">Entrate</label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="tipo-incasso"
              id="radio-uscite"
              value="uscite"
              required />
            <label class="form-check-label" for="radio-uscite">Uscite</label>
            <div class="invalid-feedback">Seleziona un tipo di incasso.</div>
          </div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Tipo di Pagamento</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="tipo-pagamento"
              id="radio-contanti"
              value="contanti"
              required />
            <label class="form-check-label" for="radio-contanti"
              >Contanti</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="tipo-pagamento"
              id="radio-pos"
              value="pos"
              required />
            <label class="form-check-label" for="radio-pos">POS</label>
            <div class="invalid-feedback">Seleziona un tipo di pagamento.</div>
          </div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Tipo di documento</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="tipo-documento"
              id="radio-fattura"
              value="fattura"
              required />
            <label class="form-check-label" for="radio-fattura">Fattura</label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="tipo-documento"
              id="radio-scontrino"
              value="scontrino"
              required />
            <label class="form-check-label" for="radio-scontrino"
              >Scontrino</label
            >
            <div class="invalid-feedback">Seleziona un tipo di documento.</div>
          </div>
        </div>

        <div class="col-md-12">
          <label for="descrizione" class="form-label">Descrizione</label>
          <input
            type="text"
            class="form-control"
            id="descrizione"
            placeholder="Inserire numero pratica" />
        </div>
        <input type="hidden" id="operatore" name="operatore" />

        <div class="col-md-12">
          <button class="btn btn-primary" type="submit">Salva</button>
        </div>
      </form>

      <div class="response"></div>

      <div class="mt-4 mb-4">
        <h3>Incassi del Giorno</h3>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Importo (€)</th>
                <th>Tipo</th>
                <th>Pagamento</th>
                <th>Documento</th>
                <th>Descrizione</th>
                <th>Operatore</th>
                <th>Ora</th>
              </tr>
            </thead>
            <tbody id="incassi-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div
      id="confirm-modal"
      class="modal fade"
      tabindex="-1"
      role="dialog"
      aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Conferma Dati</h5>
          </div>
          <div class="modal-body" id="modal-content"></div>
          <div class="modal-footer">
            <button id="cancel-button" class="btn btn-secondary me-2">
              Annulla
            </button>
            <button id="confirm-button" class="btn btn-primary">
              Conferma
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>
    <script>
      // Funzione per validare i radio button obbligatori
      function validateRadioButtons() {
        let hasError = false;

        // Validazione Tipo Incasso
        const tipoIncasso = document.querySelector(
          'input[name="tipo-incasso"]:checked'
        );
        if (!tipoIncasso) {
          hasError = true;
        }

        // Validazione Tipo Pagamento
        const tipoPagamento = document.querySelector(
          'input[name="tipo-pagamento"]:checked'
        );
        if (!tipoPagamento) {
          hasError = true;
        }

        // Validazione Tipo Documento
        const tipoDocumento = document.querySelector(
          'input[name="tipo-documento"]:checked'
        );
        if (!tipoDocumento) {
          hasError = true;
        }

        return hasError;
      }

      // Funzione che viene chiamata nel submit
      (() => {
        "use strict";

        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        const forms = document.querySelectorAll(".needs-validation");

        // Loop over them and prevent submission
        Array.from(forms).forEach((form) => {
          form.addEventListener(
            "submit",
            (event) => {
              if (form.checkValidity() && !validateRadioButtons()) {
                event.preventDefault();
                event.stopPropagation();
                salvaIncasso();
              } else {
                event.preventDefault(); // Evita la ricarica della pagina
                event.stopPropagation();
              }

              form.classList.add("was-validated");
            },
            false
          );
        });
      })();

      // Funzione per ottenere i dati dal form
      function getFormData() {
        return {
          importo: parseFloat(document.getElementById("importo").value) || 0,
          tipoIncasso: document.querySelector(
            'input[name="tipo-incasso"]:checked'
          )?.value, // Prendi il valore selezionato
          tipoPagamento: document.querySelector(
            'input[name="tipo-pagamento"]:checked'
          )?.value, // Prendi il valore selezionato
          tipoDocumento: document.querySelector(
            'input[name="tipo-documento"]:checked'
          )?.value, // Prendi il valore selezionato
          descrizione:
            document.getElementById("descrizione")?.value || "Non specificato",
        };
      }

      function showFieldError(fieldId, errorId, message) {
        const field = document.getElementById(fieldId);
        const error = document.getElementById(errorId);

        // Aggiunge la classe di errore
        field.classList.add("is-invalid");
        error.innerText = message;
        error.classList.remove("d-none");
      }

      function clearFieldError(fieldId, errorId) {
        const field = document.getElementById(fieldId);
        const error = document.getElementById(errorId);

        if (!field) {
          console.error(`Campo con ID '${fieldId}' non trovato.`);
          return;
        }
        if (!error) {
          console.error(`Errore con ID '${errorId}' non trovato.`);
          return;
        }

        // Rimuove la classe di errore
        field.classList.remove("is-invalid");
        error.classList.add("d-none");
        error.innerText = "";
      }

      function validateImporto(input) {
        input.value = input.value
          .replace(/[^0-9.,]/g, "") // Solo numeri, punto e virgola
          .replace(/,/g, ".") // Converte la virgola in punto
          .replace(/(\..*?)\..*/g, "$1") // Rimuove ulteriori punti
          .replace(/^0+(?!\.|$)/, "") // Rimuove zeri iniziali
          .replace(/(\.\d{2}).*/, "$1"); // Limita a due decimali

        if (parseFloat(input.value) <= 0 || isNaN(parseFloat(input.value))) {
          showFieldError(
            "importo",
            "importo-error",
            "Inserisci un importo valido e positivo."
          );
        } else {
          clearFieldError("importo", "importo-error");
        }
      }

      // Funzione per mostrare il messaggio di successo
      function showSuccessMessage(message) {
        const responseContainer = document.querySelector(".response");
        responseContainer.innerHTML = ""; // Rimuove i messaggi precedenti
        const successMessage = document.createElement("div");
        successMessage.className = "alert alert-success mt-3";
        successMessage.innerText = message;
        responseContainer.appendChild(successMessage);
        setTimeout(() => successMessage.remove(), 3000);
      }

      // Funzione per mostrare il modal di conferma
      function showConfirmModal(contentHTML, onConfirm) {
        const modalElement = new bootstrap.Modal(
          document.getElementById("confirm-modal")
        );
        document.getElementById("modal-content").innerHTML = contentHTML;
        const confirmButton = document.getElementById("confirm-button");
        const cancelButton = document.getElementById("cancel-button");

        confirmButton.onclick = () => {
          modalElement.hide();
          onConfirm();
        };

        cancelButton.onclick = () => {
          modalElement.hide();
        };

        modalElement.show();
      }

      // Funzione per salvare l'incasso
      function salvaIncasso() {
        const formData = getFormData(); // Ottieni i dati dal form

        const currentTime = new Date().toLocaleTimeString("it-IT");
        const currentDate = new Date().toLocaleDateString("it-IT", {
          weekday: "long",
          day: "2-digit",
          month: "long",
          year: "numeric",
        });
        const currentDateISO = new Date().toISOString().split("T")[0]; // Ottieni la data in formato YYYY-MM-DD
        const currentTimeISO = new Date()
          .toISOString()
          .split("T")[1]
          .split(".")[0]; // Ottieni l'ora in formato HH:MM:SS

        formData.operatoreId = userId;
        formData.operatoreNome = userName;

        const dataToSend = {
          ...formData,
          data: currentDateISO,
          ora: currentTimeISO,
        };

        let hasError = false;

        // Validazione Importo
        const importoNumerico = formData.importo;
        if (isNaN(importoNumerico) || importoNumerico <= 0) {
          hasError = true;
          console.error("Importo non valido.");
          console.log("Importo:", importoNumerico);
        }

        // Validazione Operatore
        if (!formData.operatoreId) {
          hasError = true;
          console.error("Operatore non valido.");
        }

        // Interrompi se ci sono errori
        if (hasError) {
          return;
        }

        const tipoIncassoFormatted =
          tipoIncassoMap[formData.tipoIncasso] || formData.tipoIncasso;
        const tipoPagamentoFormatted =
          tipoPagamentoMap[formData.tipoPagamento] || formData.tipoPagamento;
        const tipoDocumentoFormatted =
          tipoDocumentoMap[formData.tipoDocumento] || formData.tipoDocumento;

        const datiConferma = `
                  <ul>
                    <li><strong>Importo:</strong> € ${importoNumerico.toFixed(
                      2
                    )}</li>
                    <li><strong>Tipo Incasso:</strong> ${tipoIncassoFormatted}</li>
                    <li><strong>Tipo Pagamento:</strong> ${tipoPagamentoFormatted}</li>
                    <li><strong>Tipo Documento:</strong> ${tipoDocumentoFormatted}</li>
                    <li><strong>Descrizione:</strong> ${
                      formData.descrizione
                    }</li>
                  </ul>`;

        showConfirmModal(datiConferma, () => {
          fetch("/api/incassi", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(dataToSend),
          })
            .then((response) => response.json())
            .then((result) => {
              if (result.success) {
                showSuccessMessage("Incasso salvato con successo!");
                caricaIncassi(currentDateISO); // Ricarica la tabella
                resetFormState("incasso-form"); // Resetta il form
              } else {
                console.error("Errore durante il salvataggio:", result.message);
              }
            })
            .catch((error) => {
              console.error("Errore durante la chiamata al server:", error);
            });
        });
      }

      function resetFormState(formId) {
        const form = document.getElementById(formId);

        if (!form) {
          console.error(`Il form con ID '${formId}' non esiste.`);
          return;
        }

        // Rimuove tutte le classi di validazione
        form.classList.remove("was-validated");

        // Ripristina gli stati iniziali di tutti i campi
        form
          .querySelectorAll(".form-control, .form-check-input")
          .forEach((field) => {
            field.classList.remove("is-valid", "is-invalid");
          });

        // Nasconde tutti i messaggi di errore
        form
          .querySelectorAll(".invalid-feedback, .valid-feedback")
          .forEach((feedback) => {
            feedback.classList.add("d-none");
            feedback.innerText = ""; // Rimuove eventuali messaggi personalizzati
          });

        // Reset dei valori del modulo
        form.reset();
      }

      const tipoIncassoMap = {
        entrate: "Entrate",
        uscite: "Uscite",
      };

      const tipoPagamentoMap = {
        contanti: "Contanti",
        pos: "POS",
      };

      const tipoDocumentoMap = {
        fattura: "Fattura",
        scontrino: "Scontrino",
      };

      // Funzione per caricare gli incassi
      function caricaIncassi(date) {
        fetch(`/api/incassi/${date}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const incassi = data.incassi;
              let totaleCassa = 0;
              let totaleContanti = 0;
              let totalePOS = 0;

              const list = document.getElementById("incassi-list");
              list.innerHTML = "";

              incassi.forEach((incasso, index) => {
                const importo = parseFloat(incasso.importo);
                if (incasso.tipo_incasso === "uscite") {
                  if (incasso.tipo_pagamento === "contanti") {
                    totaleCassa -= importo;
                    totaleContanti -= importo;
                  } else if (incasso.tipo_pagamento === "pos")
                    totalePOS -= importo;
                } else {
                  if (incasso.tipo_pagamento === "contanti") {
                    totaleCassa += importo;
                    totaleContanti += importo;
                  } else if (incasso.tipo_pagamento === "pos")
                    totalePOS += importo;
                }

                // Usa la mappa per ottenere il valore formattato
                const tipoIncassoFormatted =
                  tipoIncassoMap[incasso.tipo_incasso] || incasso.tipo_incasso;
                const tipoPagamentoFormatted =
                  tipoPagamentoMap[incasso.tipo_pagamento] ||
                  incasso.tipo_pagamento;
                const tipoDocumentoFormatted =
                  tipoDocumentoMap[incasso.tipo_documento] ||
                  incasso.tipo_documento;

                // Formattare l'ora nel fuso orario locale
                const oraFormatted = new Intl.DateTimeFormat("it-IT", {
                  hour: "2-digit",
                  minute: "2-digit",
                  second: "2-digit",
                  hour12: false,
                }).format(new Date(`${date}T${incasso.ora}Z`));

                const row = document.createElement("tr");
                row.innerHTML = `
                <!-- Colonne in modalità view -->
                <td class="view">€ ${importo.toFixed(2)}</td>
                <td class="view">${tipoIncassoFormatted}</td>
                <td class="view">${tipoPagamentoFormatted}</td>
                <td class="view">${tipoDocumentoFormatted}</td>
                <td class="view">${incasso.descrizione}</td>

                <!-- Colonne in modalità edit -->
                <td class="edit">
                  <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <span class="input-group-text text-sm" id="basic-addon1" style="font-size: 0.8rem;">&euro;</span>
                    </div>
                    <input type="text" class="form-control form-control-sm" id="importo"
                  placeholder="Inserisci importo"
                  required
                  oninput="validateImporto(this)" value="${importo.toFixed(
                    2
                  )}" />
                  </div>
                </td>
                <!-- Tipo Incasso - Menu a tendina invece dei radio button -->
                <td class="edit">
                  <select class="form-control form-control-sm">
                    <option ${
                      tipoIncassoFormatted === "Entrate" ? "selected" : ""
                    }>Entrate</option>
                    <option ${
                      tipoIncassoFormatted === "Uscite" ? "selected" : ""
                    }>Uscite</option>
                  </select>
                </td>

                <!-- Tipo Pagamento - Menu a tendina (puoi usare un input se preferisci) -->
                <td class="edit">
                  <select class="form-control form-control-sm">
                    <option ${
                      tipoPagamentoFormatted === "Contanti" ? "selected" : ""
                    }>Contanti</option>
                    <option ${
                      tipoPagamentoFormatted === "POS" ? "selected" : ""
                    }>POS</option>
                  </select>
                </td>

                <!-- Tipo Documento - Menu a tendina -->
                <td class="edit">
                  <select class="form-control form-control-sm">
                    <option ${
                      tipoDocumentoFormatted === "Fattura" ? "selected" : ""
                    }>Fattura</option>
                    <option ${
                      tipoDocumentoFormatted === "Scontrino" ? "selected" : ""
                    }>Scontrino</option>
                  </select>
                </td>
                <td class="edit">
                  <input type="text" class="form-control form-control-sm" id="descrizione"
                  placeholder="Inserire numero pratica" value="${
                    incasso.descrizione
                  }" />
                </td>

                <td>${incasso.nome_utente || "Non specificato"}</td>
                <td>${oraFormatted}</td>

                <!-- Icone per Modifica e Elimina in modalità view -->
                <td class="text-end view">
                  <div style="white-space: nowrap">
                  <i class="fas fa-edit text-warning me-2" onclick="modificaIncasso(${
                    index + 1
                  })" style="cursor: pointer;"></i>
                    <i class="fas fa-trash-alt text-danger" onclick="eliminaIncasso(${
                      index + 1
                    })" style="cursor: pointer;"></i>
                    </div>
                    </td>

                      <!-- Icone per Salvataggio e Annullamento in modalità edit -->
                      <td class="text-end edit" style="display:none;">
                  <i class="fas fa-save text-success me-2" onclick="salvaModifiche(${
                    index + 1
                  })" style="cursor: pointer;"></i>
                  <i class="fas fa-times text-danger" onclick="annullaModifiche(${
                    index + 1
                  })" style="cursor: pointer;"></i>
                </td>
              `;

                list.appendChild(row);
              });

              document.getElementById("totale-cassa").innerText =
                totaleCassa.toFixed(2);
              document.getElementById("totale-contanti").innerText =
                totaleContanti.toFixed(2);
              document.getElementById("totale-pos").innerText =
                totalePOS.toFixed(2);
            }
          })
          .catch((error) => {
            console.error(
              "Errore durante il caricamento degli incassi:",
              error
            );
          });
      }

      function modificaIncasso(index) {
        const row = document.querySelectorAll("tr")[index];
        const viewCells = row.querySelectorAll(".view");
        const editCells = row.querySelectorAll(".edit");

        // Nascondi le celle di visualizzazione e mostra quelle di modifica
        viewCells.forEach((cell) => (cell.style.display = "none"));
        editCells.forEach((cell) => (cell.style.display = "table-cell"));

        // Nascondi le icone di modifica/eliminazione e mostra quelle di salvataggio/annullamento
        const editIcons = row.querySelectorAll(".view i");
        const saveCancelIcons = row.querySelectorAll(".edit i");

        // Verifica se le icone sono effettivamente trovate prima di modificare il display
        if (editIcons.length > 0) {
          editIcons.forEach((icon) => (icon.style.display = "none"));
        }

        if (saveCancelIcons.length > 0) {
          saveCancelIcons.forEach(
            (icon) => (icon.style.display = "inline-block")
          );
        }
      }

      function salvaModifiche(index) {
        const row = document.querySelectorAll("tr")[index];
        const editCells = row.querySelectorAll(".edit");
        const viewCells = row.querySelectorAll(".view");

        // Prendi i nuovi valori dai campi di input
        const importo = editCells[0].querySelector("input").value;
        const tipoIncasso = editCells[1].querySelector("input").value;
        const tipoPagamento = editCells[2].querySelector("input").value;
        const tipoDocumento = editCells[3].querySelector("input").value;
        const descrizione = editCells[4].querySelector("input").value;

        // Salva i nuovi dati nel localStorage
        const currentTime = new Date().toLocaleTimeString("it-IT");

        // Aggiorna il row con i nuovi valori
        row.querySelector(".view:nth-child(1)").innerHTML = `€ ${parseFloat(
          importo
        ).toFixed(2)}`;
        row.querySelector(".view:nth-child(2)").innerHTML = tipoIncasso;
        row.querySelector(".view:nth-child(3)").innerHTML = tipoPagamento;
        row.querySelector(".view:nth-child(4)").innerHTML = tipoDocumento;
        row.querySelector(".view:nth-child(5)").innerHTML = descrizione;
        row.querySelector(".view:nth-child(6)").innerHTML = currentTime;

        // Riporta la tabella alla modalità di visualizzazione
        viewCells.forEach((cell) => (cell.style.display = "table-cell"));
        editCells.forEach((cell) => (cell.style.display = "none"));

        // Nascondi le icone di salvataggio/annullamento e mostra quelle di modifica/eliminazione
        row.querySelector(".view i").style.display = "inline-block";
        row.querySelector(".edit i").style.display = "none";

        // Aggiorna i dati nel localStorage
        aggiornaStorage(
          index,
          importo,
          tipoIncasso,
          tipoPagamento,
          tipoDocumento,
          descrizione,
          currentTime
        );
      }

      function annullaModifiche(index) {
        const row = document.querySelectorAll("tr")[index];
        const editCells = row.querySelectorAll(".edit");
        const viewCells = row.querySelectorAll(".view");

        // Riporta la tabella alla modalità di visualizzazione senza salvare le modifiche
        viewCells.forEach((cell) => (cell.style.display = "table-cell"));
        editCells.forEach((cell) => (cell.style.display = "none"));

        // Nascondi le icone di salvataggio/annullamento e mostra quelle di modifica/eliminazione
        row.querySelector(".view i").style.display = "inline-block";
        row.querySelector(".edit i").style.display = "none";
      }

      function aggiornaStorage(
        index,
        importo,
        tipoIncasso,
        tipoPagamento,
        tipoDocumento,
        descrizione,
        ora
      ) {
        const currentDateISO = new Date().toISOString().split("T")[0];
        let data = JSON.parse(localStorage.getItem("incassi")) || {};

        // Aggiungi i nuovi dati nell'array
        data[currentDateISO][index] = {
          importo,
          tipoIncasso,
          tipoPagamento,
          tipoDocumento,
          descrizione,
          ora,
        };

        localStorage.setItem("incassi", JSON.stringify(data));
      }

      let userId = null;
      let userName = null;

      // Gestione iniziale della pagina
      document.addEventListener("DOMContentLoaded", function () {
        const tipoIncassoRadios = document.getElementsByName("tipo-incasso");
        const tipoPagamentoRadios =
          document.getElementsByName("tipo-pagamento");

        tipoIncassoRadios.forEach((radio) => {
          radio.addEventListener("change", function () {
            // Se "Uscite" è selezionato e "POS" è selezionato, cambia automaticamente a "Contanti"
            if (
              document.getElementById("radio-uscite").checked &&
              document.getElementById("radio-pos").checked
            ) {
              document.getElementById("radio-contanti").checked = true;
            }
          });
        });

        tipoPagamentoRadios.forEach((radio) => {
          radio.addEventListener("change", function () {
            // Se "Uscite" è selezionato e "POS" è selezionato, cambia automaticamente a "Entrate"
            if (
              document.getElementById("radio-uscite").checked &&
              document.getElementById("radio-pos").checked
            ) {
              document.getElementById("radio-entrate").checked = true;
            }
          });
        });

        const today = new Date();
        const formattedToday = today
          .toLocaleDateString("it-IT", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          })
          .split("/")
          .reverse()
          .join("-");

        function formatDateToItalian(date) {
          const formattedDate = date.toLocaleDateString("it-IT", {
            weekday: "long",
            day: "2-digit",
            month: "long",
            year: "numeric",
          });
          return formattedDate
            .split(" ")
            .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ");
        }

        document.getElementById("current-date").innerText =
          formatDateToItalian(today);

        flatpickr("#calendar", {
          altInput: true,
          altFormat: "l, j M Y",
          dateFormat: "Y-m-d",
          defaultDate: formattedToday,
          locale: "it",
          onChange: function (selectedDates, dateStr) {
            const selectedDate = selectedDates[0];
            if (selectedDate) {
              const formattedDate = formatDateToItalian(selectedDate);
              document.getElementById("current-date").innerText = formattedDate;
              toggleFormVisibility(dateStr);
              caricaIncassi(dateStr);
            }
          },
        });

        toggleFormVisibility(formattedToday);
        caricaIncassi(formattedToday);

        fetch("/api/utente")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Non autenticato");
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              userId = data.userId; // Salva l'ID utente
              userName = data.userName; // Salva il nome utente
              // Aggiorna l'interfaccia utente con il nome
              document.getElementById(
                "user-name"
              ).textContent = `Utente registrato: ${userName}`;
            } else {
              redirectToLogin();
            }
          })
          .catch((error) => {
            console.error(
              "Errore durante il caricamento del nome utente:",
              error
            );
            document.getElementById("user-name").textContent =
              "Utente non configurato";
            redirectToLogin();
          });
      });

      // Durata della sessione (in millisecondi)
      const sessionTimeout = 3600000; // 1 ora (3600 secondi * 1000)

      // Variabile per il timer
      let sessionTimer;

      // Funzione per resettare il timer
      function resetSessionTimer() {
        // Cancella il timer precedente
        if (sessionTimer) {
          clearTimeout(sessionTimer);
        }

        // Imposta un nuovo timer
        sessionTimer = setTimeout(() => {
          redirectToLogin();
        }, sessionTimeout);
      }

      // Funzione per reindirizzare al login
      function redirectToLogin() {
        window.location.href = "/login.html";
      }

      // Aggiungi gli eventi per rilevare l'attività dell'utente
      function setupSessionTimeoutHandler() {
        const events = [
          "mousemove",
          "keydown",
          "click",
          "scroll",
          "touchstart",
        ];
        events.forEach((event) => {
          window.addEventListener(event, resetSessionTimer);
        });

        // Imposta il primo timer all'avvio
        resetSessionTimer();
      }

      // Inizializza il gestore della sessione al caricamento della pagina
      document.addEventListener("DOMContentLoaded", () => {
        setupSessionTimeoutHandler();
      });

      function redirectToLogin() {
        // Reindirizza alla pagina di login
        window.location.href = "/login.html";
      }
      // Mostra o nasconde il form di inserimento incassi
      function toggleFormVisibility(selectedDate) {
        if (!selectedDate) {
          console.warn("Nessuna data selezionata.");
          return;
        }

        const form = document.getElementById("incasso-form");
        if (!form) {
          console.error("Il form con ID 'incasso-form' non esiste.");
          return;
        }

        const currentDate = new Date()
          .toLocaleDateString("it-IT", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          })
          .split("/")
          .reverse()
          .join("-");

        form.classList.toggle("d-none", selectedDate !== currentDate);
      }
    </script>
  </body>
</html>
